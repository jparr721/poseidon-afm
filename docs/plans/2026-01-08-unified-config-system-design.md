# Unified Config System Design

**Date:** 2026-01-08
**Status:** Approved

## Overview

Create a unified configuration system that enables building Poseidon agents from a JSON config file generated by a React UI. A Go-based builder tool handles config generation, cross-compilation, and outputs a ready-to-run agent binary.

## Problem Statement

Currently, the agent has fragmented configuration:

- **`main.go`** reads environment variables for UI polling client settings
- **Profile code** uses ldflags + base64-encoded JSON injected at build time
- **`utils.go`** has debug settings via ldflags

This makes it impossible to have a single, externally-generated configuration that controls the entire agent.

## Solution Architecture

### Builder Tool

A standalone Go program at `cmd/builder/main.go` that:

1. Reads a JSON config (what the React UI generates)
2. Templates it into `config.go`
3. Copies to both module locations
4. Runs `go build` with the right GOOS/GOARCH/tags

**Invocation:**

```bash
./builder --config payload.json           # Build with config
./builder --config payload.json --dry-run # Validate only, show what would happen
./builder --validate payload.json         # Just validate, no build
```

**React UI workflow:**

1. User fills form → JSON payload
2. Server writes JSON to temp file
3. Server runs `builder --config temp.json`
4. Builder outputs the compiled agent binary path
5. Server returns binary to user

### Config File Locations

The builder generates identical `config.go` files in two locations (due to separate Go modules):

- `poseidon/config/config.go` (for main.go's UI polling client)
- `poseidon/poseidon/agent_code/pkg/config/config.go` (for profiles)

Both are `.gitignore`d. A `config.example.go` shows the structure.

## JSON Config Schema

```jsonc
{
  // ============================================================
  // GLOBAL SETTINGS (required)
  // ============================================================
  "uuid": "unique-agent-identifier",
  "debug": false,

  // ============================================================
  // BUILD SETTINGS
  // ============================================================
  "build": {
    "os": "windows",                   // required: "windows" | "linux" | "darwin"
    "arch": "amd64",                   // required: "amd64" | "arm64"
    "output": "./agent",               // optional, default "./agent" (adds .exe for windows)
    "mode": "default",                 // optional: "default" | "c-archive" | "c-shared"
    "garble": false,                   // optional, enables code obfuscation (slower builds)
    "static": false,                   // optional, static linking (linux only)
    "cgo": false                       // optional, enable CGO (required for some macOS features)
  },

  // ============================================================
  // PROFILE SELECTION (required - at least one profile)
  // ============================================================
  "profiles": ["http", "websocket"],

  // ============================================================
  // C2 FAILOVER SETTINGS (optional - defaults shown)
  // ============================================================
  "egress": {
    "order": ["http", "websocket"],    // optional, defaults to profiles order
    "failover": "failover",            // optional: "failover" | "round-robin"
    "failedThreshold": 10,             // optional, default 10
    "backoffDelay": 5,                 // optional, seconds
    "backoffBase": 1                   // optional, seconds
  },

  // ============================================================
  // UI POLLING CLIENT (optional - only for standalone mode)
  // ============================================================
  "uiClient": {
    "baseUrl": "http://localhost:11111",
    "checkinPath": "/checkin",         // optional, default "/checkin"
    "pollPath": "/poll",               // optional, default "/poll"
    "pollInterval": 5,                 // optional, seconds, default 5
    "httpTimeout": 30                  // optional, seconds, default 30
  },

  // ============================================================
  // HTTP PROFILE (required if "http" in profiles)
  // ============================================================
  "http": {
    "callbackHost": "https://c2.example.com",  // required
    "callbackPort": 443,                        // required
    "aesPsk": "base64-encoded-key",             // required
    "killdate": "2025-12-31",                   // required
    "interval": 10,                             // required, seconds
    "jitter": 20,                               // required, percentage 0-100
    "postUri": "/data",                         // required
    "getUri": "/news",                          // required
    "queryPathName": "q",                       // optional, default "q"
    "encryptedExchangeCheck": true,             // optional, default true
    "headers": {                                // optional
      "User-Agent": "Mozilla/5.0",
      "Accept": "application/json"
    },
    "proxy": {                                  // optional block
      "host": "proxy.internal.com",
      "port": 8080,
      "user": "",                               // optional
      "pass": "",                               // optional
      "bypass": false                           // optional, default false
    }
  },

  // ============================================================
  // WEBSOCKET PROFILE (required if "websocket" in profiles)
  // ============================================================
  "websocket": {
    "callbackHost": "wss://c2.example.com",    // required
    "callbackPort": 443,                        // required
    "aesPsk": "base64-encoded-key",             // required
    "killdate": "2025-12-31",                   // required
    "interval": 10,                             // required, seconds
    "jitter": 20,                               // required, percentage
    "endpoint": "/socket",                      // required
    "encryptedExchangeCheck": true,             // optional, default true
    "domainFront": "",                          // optional
    "taskingType": "Push",                      // optional: "Push" | "Poll", default "Push"
    "userAgent": "Mozilla/5.0"                  // optional
  },

  // ============================================================
  // TCP PROFILE (required if "tcp" in profiles)
  // ============================================================
  "tcp": {
    "port": 8080,                              // required
    "aesPsk": "base64-encoded-key",            // required
    "killdate": "2025-12-31",                  // required
    "encryptedExchangeCheck": true             // optional, default true
  },

  // ============================================================
  // DNS PROFILE (required if "dns" in profiles)
  // ============================================================
  "dns": {
    "domains": ["c2.example.com", "backup.example.com"],  // required
    "aesPsk": "base64-encoded-key",            // required
    "killdate": "2025-12-31",                  // required
    "interval": 10,                            // required, seconds
    "jitter": 20,                              // required, percentage
    "server": "8.8.8.8:53",                    // optional, uses system DNS if empty
    "domainRotation": "fail-over",             // optional: "fail-over" | "round-robin" | "random"
    "failoverThreshold": 3,                    // optional, default 3
    "recordType": "TXT",                       // optional: "A" | "AAAA" | "TXT", default "TXT"
    "maxQueryLength": 253,                     // optional
    "maxSubdomainLength": 63,                  // optional
    "encryptedExchangeCheck": true             // optional, default true
  },

  // ============================================================
  // DYNAMICHTTP PROFILE (required if "dynamichttp" in profiles)
  // ============================================================
  "dynamichttp": {
    "aesPsk": "base64-encoded-key",            // required
    "killdate": "2025-12-31",                  // required
    "interval": 10,                            // required
    "jitter": 20,                              // required
    "encryptedExchangeCheck": true,            // optional, default true
    "rawC2Config": "{...}"                     // required, JSON string with full dynamic config
  },

  // ============================================================
  // HTTPX PROFILE (required if "httpx" in profiles)
  // ============================================================
  "httpx": {
    "callbackDomains": ["c2a.example.com", "c2b.example.com"],  // required
    "aesPsk": "base64-encoded-key",            // required
    "killdate": "2025-12-31",                  // required
    "interval": 10,                            // required
    "jitter": 20,                              // required
    "domainRotationMethod": "fail-over",       // optional: "fail-over" | "round-robin" | "random"
    "failoverThreshold": 3,                    // optional
    "encryptedExchangeCheck": true,            // optional, default true
    "rawC2Config": "{...}"                     // required, JSON string with full config
  }
}
```

## Builder Pipeline

```
JSON Input → Validate → Generate config.go → Copy to modules → go build → Binary Output
```

### Stage 1: Parse & Validate

Read JSON, unmarshal into Go structs, validate:
- Required fields present
- Profile configs exist for each profile in `profiles` array
- Build target is valid (os/arch combination)
- Killdates are valid dates
- Intervals/jitter are sane values

Returns clear errors: `"http.callbackHost is required when 'http' profile is selected"`

### Stage 2: Generate config.go

Use Go's `text/template` to generate the config source file. The template contains all the variable definitions and populates values from the JSON. Unused profiles get zero values.

### Stage 3: Copy to both module locations

Write identical `config.go` to:
- `poseidon/config/config.go`
- `poseidon/poseidon/agent_code/pkg/config/config.go`

Create directories if they don't exist.

### Stage 4: Execute build

Run `go build` with:
- `GOOS` / `GOARCH` from config
- `-tags` for selected profiles (e.g., `-tags="http,websocket"`)
- `-o` for output path
- Optional: pipe through `garble` if enabled

## Generated config.go Structure

```go
// Code generated by poseidon builder. DO NOT EDIT.
package config

// Global Settings
var (
    UUID  = "abc-123-def-456"
    Debug = false
)

// Build Info (for runtime inspection)
var (
    BuildOS   = "windows"
    BuildArch = "amd64"
)

// Egress Settings
var (
    EgressOrder       = []string{"http", "websocket"}
    EgressFailover    = "failover"
    FailedThreshold   = 10
    BackoffDelay      = 5
    BackoffBase       = 1
)

// UI Client Settings
var (
    UIBaseURL      = "http://localhost:11111"
    UICheckinPath  = "/checkin"
    UIPollPath     = "/poll"
    UIPollInterval = 5
    UIHTTPTimeout  = 30
)

// HTTP Profile
var (
    HTTPCallbackHost         = "https://c2.example.com"
    HTTPCallbackPort         = 443
    HTTPAesPsk               = "base64-key"
    HTTPKilldate             = "2025-12-31"
    HTTPInterval             = 10
    HTTPJitter               = 20
    HTTPPostUri              = "/data"
    HTTPGetUri               = "/news"
    HTTPQueryPathName        = "q"
    HTTPEncryptedExchange    = true
    HTTPHeaders              = map[string]string{"User-Agent": "Mozilla/5.0"}
    HTTPProxyHost            = ""
    HTTPProxyPort            = 0
    HTTPProxyUser            = ""
    HTTPProxyPass            = ""
    HTTPProxyBypass          = false
)

// Websocket, TCP, DNS, DynamicHTTP, HTTPx follow same pattern...
```

## Profile Integration

### Current State

Each profile reads a base64-encoded JSON blob injected via ldflags at build time.

### New State

Profiles import the config package and read variables directly.

**Example - http.go transformation:**

```go
// BEFORE (current)
var http_initial_config string  // ldflags: -X 'http_initial_config=base64...'

func init() {
    decoded, _ := base64.StdEncoding.DecodeString(http_initial_config)
    json.Unmarshal(decoded, &initialConfig)
    // use initialConfig.CallbackHost, etc.
}

// AFTER (new)
import "github.com/MythicAgents/poseidon/poseidon/agent_code/pkg/config"

func init() {
    // Direct access, no decoding
    callbackHost := config.HTTPCallbackHost
    callbackPort := config.HTTPCallbackPort
    aesPsk := config.HTTPAesPsk
    // ...
}
```

### Files to Modify

| File | Remove | Add |
|------|--------|-----|
| `http.go` | `var http_initial_config`, base64 decode | import config, direct reads |
| `websocket.go` | `var websocket_initial_config`, base64 decode | import config, direct reads |
| `tcp.go` | `var tcp_initial_config`, base64 decode | import config, direct reads |
| `dns.go` | `var dns_initial_config`, base64 decode | import config, direct reads |
| `dynamichttp.go` | `var dynamichttp_initial_config`, base64 decode | import config, direct reads |
| `httpx.go` | `var httpx_initial_config`, base64 decode | import config, direct reads |
| `profile.go` | ldflags for UUID, egress | import config for shared settings |
| `utils.go` | `var debugString` | import config, use `config.Debug` |
| `main.go` | env var reading | import config for UI client settings |

## Implementation Plan

### Phase 1: Create Builder Tool

1. Create `cmd/builder/main.go` with CLI parsing
2. Create `cmd/builder/types.go` with JSON config structs
3. Create `cmd/builder/validate.go` with validation logic
4. Create `cmd/builder/templates/config.go.tmpl` template
5. Create `cmd/builder/generate.go` to render template
6. Create `cmd/builder/build.go` to execute go build

### Phase 2: Create Config Package Structure

1. Create `poseidon/config/` directory
2. Create `poseidon/poseidon/agent_code/pkg/config/` directory
3. Add both `config/config.go` paths to `.gitignore`
4. Create `config.example.go` in both locations for reference

### Phase 3: Migrate Profile Code

1. Update `profile.go` to use config for UUID, egress settings
2. Update `http.go` to use config package
3. Update `websocket.go` to use config package
4. Update `tcp.go` to use config package
5. Update `dns.go` to use config package
6. Update `dynamichttp.go` to use config package
7. Update `httpx.go` to use config package

### Phase 4: Migrate Supporting Code

1. Update `utils.go` to use `config.Debug`
2. Update `main.go` to use config package instead of env vars

### Phase 5: Update Build System

1. Update `Makefile` - remove ldflags, simplify to just `go build`
2. Add example JSON configs for testing
3. Test cross-compilation for all target platforms

## Notes

- **CGO Warning:** Some macOS features require CGO (clipboard, screenshots, prompts, keylogging, XPC). The UI should warn when `os: darwin` and `cgo: false`.
- **Garble:** Obfuscation via garble tool is optional and slows builds significantly.
- **Static Linking:** Only applicable to Linux builds.
